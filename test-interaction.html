<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>äº¤äº’åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
        }
        #canvas {
            border: 2px solid #333;
            margin: 20px 0;
        }
        .info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        .test-button {
            padding: 10px 15px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #0056CC;
        }
    </style>
</head>
<body>
    <h1>ğŸ¯ äº¤äº’åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="info">
        <h3>æµ‹è¯•è¯´æ˜ï¼š</h3>
        <ul>
            <li>ğŸ¯ <strong>è§†çº¿è·Ÿè¸ª</strong>ï¼šç§»åŠ¨é¼ æ ‡ï¼Œè§’è‰²åº”è¯¥è·Ÿéšé¼ æ ‡ç§»åŠ¨è§†çº¿</li>
            <li>ğŸ‘† <strong>ç‚¹å‡»äº¤äº’</strong>ï¼šç‚¹å‡»è§’è‰²èƒ¸éƒ¨åŒºåŸŸï¼ˆç”Ÿæ°”ååº”ï¼‰æˆ–çœ¼ç›åŒºåŸŸï¼ˆå›°æƒ‘ååº”ï¼‰</li>
            <li>ğŸ˜Š <strong>è¡¨æƒ…æŒ‰é’®</strong>ï¼šç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æµ‹è¯•ä¸åŒè¡¨æƒ…</li>
            <li>ğŸ“± <strong>ç§»åŠ¨ç«¯</strong>ï¼šåœ¨æ‰‹æœºä¸Šæµ‹è¯•è§¦æ‘¸äº¤äº’</li>
        </ul>
    </div>

    <canvas id="canvas" width="640" height="480"></canvas>

    <div class="test-buttons">
        <button class="test-button" onclick="testEmotion('å¹³å¸¸')">å¹³å¸¸</button>
        <button class="test-button" onclick="testEmotion('æ€’ã‚‹01')">ç”Ÿæ°”</button>
        <button class="test-button" onclick="testEmotion('å›°ã‚‹00')">å›°æƒ‘</button>
        <button class="test-button" onclick="testEmotion('ã³ã£ãã‚Š2')">æƒŠè®¶</button>
        <button class="test-button" onclick="testEmotion('ã„ã‚„ã„ã‚„')">æ‘‡å¤´</button>
        <button class="test-button" onclick="testEmotion('ã²ã')">é€€ç¼©</button>
    </div>

    <div class="info">
        <h3>è°ƒè¯•ä¿¡æ¯ï¼š</h3>
        <div id="debug-info">ç­‰å¾…åŠ è½½...</div>
    </div>

    <script src="driver/FreeMoteDriver.js"></script>
    <script src="driver/emoteplayer.js"></script>
    <script>
        let player = null;
        let debugInfo = document.getElementById('debug-info');

        function updateDebugInfo(text) {
            debugInfo.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + text;
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }

        async function init() {
            try {
                updateDebugInfo('å¼€å§‹åˆå§‹åŒ–...');
                
                // åˆå§‹åŒ–æ’­æ”¾å™¨
                EmotePlayer.createRenderCanvas(640, 480);
                const canvas = document.getElementById('canvas');
                player = new EmotePlayer(canvas);
                player.scale = 1.0;
                
                updateDebugInfo('åŠ è½½è§’è‰²æ•°æ®...');
                
                // åŠ è½½è§’è‰²æ•°æ®
                await player.promiseLoadDataFromURL('data/choco.psb');
                
                updateDebugInfo('è®¾ç½®é»˜è®¤è¡¨æƒ…...');
                player.mainTimelineLabel = 'å¹³å¸¸';
                
                updateDebugInfo('è®¾ç½®äº¤äº’åŠŸèƒ½...');
                setupEyeTracking();
                setupTouchReactions();
                
                updateDebugInfo('âœ… åˆå§‹åŒ–å®Œæˆï¼ç°åœ¨å¯ä»¥æµ‹è¯•äº¤äº’åŠŸèƒ½äº†');
                
            } catch (error) {
                updateDebugInfo('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                console.error(error);
            }
        }

        // è§†çº¿è·Ÿè¸ªåŠŸèƒ½
        function setupEyeTracking() {
            const eyeTrackingReaction = (ev) => {
                try {
                    const eyePosition = player.getMarkerPosition('eye');
                    if (!eyePosition) return;

                    const mouseOffsetX = ev.clientX - eyePosition.clientX;
                    const mouseOffsetY = ev.clientY - eyePosition.clientY;
                    const angle = Math.atan2(mouseOffsetY, mouseOffsetX);
                    const len = Math.sqrt(mouseOffsetX ** 2 + mouseOffsetY ** 2);
                    const c = Math.cos(angle);
                    const s = Math.sin(angle);

                    // è§†çº¿è·Ÿè¸ª
                    player.setVariableDiff('eyetrack', 'face_eye_LR', len / 3 * c, 500, -1);
                    player.setVariableDiff('eyetrack', 'face_eye_UD', len / 3 * s, 500, -1);

                    // å¤´éƒ¨è·Ÿè¸ª
                    if (len > 60) {
                        player.setVariableDiff('eyetrack', 'head_slant', len / 12 * c, 1000, -1);
                        player.setVariableDiff('eyetrack', 'head_LR', len / 6 * c, 1000, -1);
                        player.setVariableDiff('eyetrack', 'head_UD', len / 6 * s, 1000, -1);
                    }

                    // èº«ä½“è·Ÿè¸ª
                    if (len > 120) {
                        player.setVariableDiff('eyetrack', 'body_slant', len / 18 * c, 2000, -1);
                        player.setVariableDiff('eyetrack', 'body_LR', len / 9 * c, 2000, -1);
                        player.setVariableDiff('eyetrack', 'body_UD', len / 9 * s, 2000, -1);
                    }
                } catch (error) {
                    console.warn('è§†çº¿è·Ÿè¸ªå¤±è´¥:', error);
                }
            };

            canvas.onmousemove = eyeTrackingReaction;
            canvas.addEventListener('touchmove', (ev) => {
                eyeTrackingReaction(ev.touches[0]);
                ev.preventDefault();
            }, false);
        }

        // è§¦æ‘¸äº¤äº’åŠŸèƒ½
        function setupTouchReactions() {
            let touching = false;

            const touchReaction = (ev) => {
                if (touching) return;

                try {
                    const bustPosition = player.getMarkerPosition('bust');
                    const eyePosition = player.getMarkerPosition('eye');

                    if (!bustPosition || !eyePosition) return;

                    const bustLength = Math.sqrt((bustPosition.clientX - ev.clientX) ** 2 + (bustPosition.clientY - ev.clientY) ** 2);
                    const eyeLength = Math.sqrt((eyePosition.clientX - ev.clientX) ** 2 + (eyePosition.clientY - ev.clientY) ** 2);

                    // ç‚¹å‡»èƒ¸éƒ¨åŒºåŸŸ
                    if (bustLength < 50) {
                        touching = true;
                        updateDebugInfo('ğŸ‘† ç‚¹å‡»èƒ¸éƒ¨åŒºåŸŸ - ç”Ÿæ°”ååº”');
                        player.mainTimelineLabel = 'æ€’ã‚‹01';
                        player.diffTimelineSlot1 = 'ã³ã£ãã‚Š2';
                        player.diffTimelineSlot2 = 'ã„ã‚„ã„ã‚„';
                        player.setVariable('arm_type', 2, 300);

                        setTimeout(() => {
                            touching = false;
                            player.mainTimelineLabel = 'å¹³å¸¸';
                            player.diffTimelineSlot1 = '';
                            player.diffTimelineSlot2 = '';
                            player.setVariable('arm_type', 0, 300);
                        }, 1500);
                    }
                    // ç‚¹å‡»çœ¼ç›åŒºåŸŸ
                    else if (eyeLength < 30) {
                        touching = true;
                        updateDebugInfo('ğŸ‘† ç‚¹å‡»çœ¼ç›åŒºåŸŸ - å›°æƒ‘ååº”');
                        player.mainTimelineLabel = 'å›°ã‚‹00';
                        player.diffTimelineSlot1 = 'ã²ã';
                        player.setVariable('face_eye_open', 32);

                        setTimeout(() => {
                            touching = false;
                            player.mainTimelineLabel = 'å¹³å¸¸';
                            player.diffTimelineSlot1 = '';
                            player.setVariable('face_eye_open', 0);
                        }, 1000);
                    }
                } catch (error) {
                    console.warn('è§¦æ‘¸äº¤äº’å¤±è´¥:', error);
                }
            };

            canvas.onclick = touchReaction;
            canvas.addEventListener('touchstart', (ev) => {
                touchReaction(ev.touches[0]);
                ev.preventDefault();
            }, false);
        }

        // æµ‹è¯•è¡¨æƒ…åŠŸèƒ½
        function testEmotion(emotion) {
            if (!player) {
                updateDebugInfo('âŒ æ’­æ”¾å™¨æœªåˆå§‹åŒ–');
                return;
            }
            
            try {
                updateDebugInfo('ğŸ˜Š æ’­æ”¾è¡¨æƒ…: ' + emotion);
                player.mainTimelineLabel = emotion;
                player.diffTimelineSlot1 = '';
                player.diffTimelineSlot2 = '';
                player.diffTimelineSlot3 = '';
                player.diffTimelineSlot4 = '';
                player.setVariable('arm_type', 0, 300);
                player.setVariable('face_eye_open', 0, 300);
            } catch (error) {
                updateDebugInfo('âŒ æ’­æ”¾è¡¨æƒ…å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

